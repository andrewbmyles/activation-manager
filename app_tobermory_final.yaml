runtime: python311
instance_class: F4

automatic_scaling:
  min_instances: 1
  max_instances: 10
  target_cpu_utilization: 0.65
  min_idle_instances: 1
  max_concurrent_requests: 20

inbound_services:
- warmup

env_variables:
  FLASK_ENV: "production"
  USE_EMBEDDINGS: "true"
  GAE_ENV: "standard"
  GOOGLE_CLOUD_PROJECT: "feisty-catcher-461000-g2"
  GCS_BUCKET: "activation-manager-embeddings"
  FRONTEND_URL: "https://tobermory.ai"
  EMBEDDING_LOAD_STRATEGY: "lazy"

handlers:
# Warmup handler
- url: /_ah/warmup
  script: auto
  login: admin

# Health and API endpoints
- url: /health
  script: auto
  secure: always

- url: /api/.*
  script: auto
  secure: always

# Activation Manager endpoint
- url: /activation-manager
  script: auto
  secure: always

# Static files for React app
- url: /static
  static_dir: audience-manager/build/static
  secure: always
  expiration: "30d"
  http_headers:
    X-Content-Type-Options: "nosniff"
    Cache-Control: "public, max-age=31536000"

# Favicon
- url: /favicon\.ico
  static_files: audience-manager/build/favicon.ico
  upload: audience-manager/build/favicon\.ico
  secure: always
  expiration: "7d"

# Logo and other assets
- url: /(logo.*\.png|manifest\.json|robots\.txt)
  static_files: audience-manager/build/\1
  upload: audience-manager/build/(logo.*\.png|manifest\.json|robots\.txt)
  secure: always
  expiration: "7d"

# Service worker
- url: /service-worker\.js
  static_files: audience-manager/build/service-worker.js
  upload: audience-manager/build/service-worker\.js
  secure: always
  http_headers:
    Cache-Control: "no-cache"

# Asset manifest
- url: /asset-manifest\.json
  static_files: audience-manager/build/asset-manifest.json
  upload: audience-manager/build/asset-manifest\.json
  secure: always
  http_headers:
    Cache-Control: "no-cache"

# Index.html for all other routes (React SPA)
- url: /.*
  static_files: audience-manager/build/index.html
  upload: audience-manager/build/index.html
  secure: always
  http_headers:
    Cache-Control: "no-cache, no-store, must-revalidate"
    X-Content-Type-Options: "nosniff"
    X-Frame-Options: "SAMEORIGIN"
    X-XSS-Protection: "1; mode=block"