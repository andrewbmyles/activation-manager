<!DOCTYPE html>
<html>
<head>
    <title>Variable Picker Demo Test</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: auto; }
        .test { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        input { padding: 8px; width: 300px; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>🧪 Variable Picker Test Page</h1>
    <p>Use this to test the Variable Picker API before using the React app.</p>
    
    <div class="test">
        <h2>1. Backend Health Check</h2>
        <button onclick="testHealth()">Test Health</button>
        <pre id="health-result"></pre>
    </div>
    
    <div class="test">
        <h2>2. Variable Search Test</h2>
        <input type="text" id="query" value="millennials with high income" placeholder="Enter search query">
        <button onclick="testSearch()">Search Variables</button>
        <pre id="search-result"></pre>
    </div>
    
    <div class="test">
        <h2>3. Full Workflow Test</h2>
        <button onclick="testFullWorkflow()">Test Complete Workflow</button>
        <pre id="workflow-result"></pre>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        
        async function testHealth() {
            const resultEl = document.getElementById('health-result');
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                resultEl.textContent = 'SUCCESS: ' + JSON.stringify(data, null, 2);
                resultEl.parentElement.classList.add('success');
            } catch (error) {
                resultEl.textContent = 'ERROR: ' + error;
                resultEl.parentElement.classList.add('error');
            }
        }
        
        async function testSearch() {
            const resultEl = document.getElementById('search-result');
            const query = document.getElementById('query').value;
            
            try {
                resultEl.textContent = 'Searching...';
                
                const response = await fetch(`${API_URL}/api/variable-picker/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, top_k: 10 })
                });
                
                const data = await response.json();
                resultEl.textContent = 'SUCCESS:\n' + JSON.stringify(data, null, 2);
                resultEl.parentElement.classList.add('success');
                
                // Store session ID for workflow test
                window.lastSessionId = data.session_id;
                
            } catch (error) {
                resultEl.textContent = 'ERROR: ' + error;
                resultEl.parentElement.classList.add('error');
            }
        }
        
        async function testFullWorkflow() {
            const resultEl = document.getElementById('workflow-result');
            resultEl.textContent = 'Running full workflow test...\n';
            
            try {
                // 1. Start search
                resultEl.textContent += '\n1. Starting search...';
                const searchResp = await fetch(`${API_URL}/api/variable-picker/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: 'online shoppers', top_k: 5 })
                });
                const searchData = await searchResp.json();
                resultEl.textContent += '\n   Found ' + searchData.suggested_count + ' variables';
                
                // 2. Refine search
                resultEl.textContent += '\n\n2. Refining search...';
                const refineResp = await fetch(`${API_URL}/api/variable-picker/refine/${searchData.session_id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refinement: 'focus on frequent shoppers' })
                });
                const refineData = await refineResp.json();
                resultEl.textContent += '\n   Refined to ' + refineData.suggested_count + ' variables';
                
                // 3. Confirm variables
                const codes = searchData.variables.slice(0, 2).map(v => v.code);
                resultEl.textContent += '\n\n3. Confirming variables: ' + codes.join(', ');
                const confirmResp = await fetch(`${API_URL}/api/variable-picker/confirm/${searchData.session_id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirmed_codes: codes })
                });
                const confirmData = await confirmResp.json();
                resultEl.textContent += '\n   Confirmed ' + confirmData.confirmed_count + ' variables';
                
                // 4. Export
                resultEl.textContent += '\n\n4. Exporting...';
                const exportResp = await fetch(`${API_URL}/api/variable-picker/export/${searchData.session_id}`);
                const exportData = await exportResp.json();
                resultEl.textContent += '\n   Export ready with ' + exportData.variables.length + ' variables';
                
                resultEl.textContent += '\n\n✅ WORKFLOW COMPLETE!';
                resultEl.parentElement.classList.add('success');
                
            } catch (error) {
                resultEl.textContent += '\n\n❌ ERROR: ' + error;
                resultEl.parentElement.classList.add('error');
            }
        }
        
        // Auto-test on load
        window.onload = () => {
            testHealth();
        };
    </script>
</body>
</html>